#!/usr/bin/env bash
set -euo pipefail
# enable job control consistently, not just when there is a tty:
set -m
IFS=" "

export OPT="${OPT-_opt}"

binaries=$(perl -we '
    my $opt = $ENV{"OPT"} // "";
    print map { s/\.c$//; "$_$opt " } @ARGV
' examples/*.c)

make -j4 $binaries

out=$(mktemp)
err=$(mktemp)

# Silence software renderer fallback
export SILENT=

for binary in $binaries; do
    echo "Testing $binary :"
    name=$(basename $binary "$OPT")
    for test in tests/$name/*; do
        echo -n "  Test $test: "
        bin/expect-exit $test/exit $test/args $test/env $binary < $test/in > "$out" 2> "$err"
        diff -u $test/err "$err"
        diff -u $test/out "$out"
        echo "OK."
    done
done
